<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cricket Animation Player</title>
    <!-- Link to Pyodide loader -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <style>
        body { margin: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; background-color: #f0f0f0; text-align: center; }
        #pygame-container canvas { border: 1px solid black; }
        /* Pygame canvas will be controlled by cricket_animation.py */
    </style>
</head>
<body>
    <div>
        <h3>Cricket Animation</h3>
        <p id="loading-status">Loading Pyodide and Pygame assets...</p>
        <div id="pygame-container">
            <!-- The Pygame canvas will be inserted here by cricket_animation.py -->
        </div>
    </div>

    <script type="text/javascript">
        const matchDataFromFlask = {{ match_data_json | safe if match_data_json else 'null' }};

        async function mainPyodide() {
            let pyodide = await loadPyodide();
            let statusElement = document.getElementById("loading-status");
            statusElement.textContent = "Pyodide loaded. Loading pygame-ce...";

            await pyodide.loadPackage(["pygame-ce"]);
            statusElement.textContent = "Pygame-ce loaded. Fetching animation script...";

            let pythonScript = await fetch("{{ url_for('static', filename='animation/cricket_animation.py') }}");
            let pythonCode = await pythonScript.text();
            statusElement.textContent = "Animation script fetched. Preparing data and running animation...";

            if (matchDataFromFlask) {
                // Make the match_data_for_animation available in Pyodide's global scope
                // The toPy() method converts JavaScript objects to Python objects (dicts, lists, etc.)
                pyodide.globals.set("match_data_for_animation", pyodide.toPy(matchDataFromFlask));
                console.log("Match data passed to Pyodide:", matchDataFromFlask);
                statusElement.textContent = "Match data loaded. Starting animation...";
            } else {
                console.log("No match data from Flask, animation will use its own UI for setup.");
                statusElement.textContent = "No pre-loaded data. Animation will start with its own UI.";
            }

            try {
                await pyodide.runPythonAsync(pythonCode);
                // If the script runs without error and sets up its own loop, this might be the last message from JS.
                // If runPythonAsync completes, it means the Python script finished.
                // For continuous animations like Pygame, the script itself should manage the loop.
                // statusElement.textContent = "Animation script execution finished by Pyodide.";
            } catch (err) {
                console.error("Error running Python script:", err);
                statusElement.textContent = "Error loading animation. See console for details.";
                document.getElementById("pygame-container").innerHTML = "<p>Error loading animation. Check console.</p>";
            }
        }
        mainPyodide();
    </script>
</body>
</html>
